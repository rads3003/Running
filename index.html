<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Carrera Urbana</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #1c1c1c;
      color: #eee;
    }

    header {
      background: url('https://images.unsplash.com/photo-1605296867304-46d5465a13f1?auto=format&fit=crop&w=1600&q=80') center/cover no-repeat;
      padding: 60px 20px;
      text-align: center;
      color: white;
    }

    header h1 {
      font-size: 2.5em;
      margin: 0;
      text-shadow: 2px 2px 4px #000;
    }

    header p {
      font-size: 1.2em;
      margin-top: 10px;
      text-shadow: 1px 1px 3px #000;
    }

    nav {
      background-color: #333;
      padding: 10px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    nav button {
      background-color: #ff6600;
      border: none;
      color: #fff;
      font-size: 1em;
      cursor: pointer;
      padding: 10px 20px;
      border-radius: 5px;
    }

    nav button:hover {
      background-color: #e65c00;
    }

    .pantalla {
      display: none;
      padding: 20px;
      text-align: center;
    }

    .visible {
      display: block;
    }

    input,
    button {
      padding: 10px;
      margin: 10px 0;
      width: 80%;
      max-width: 400px;
      font-size: 1em;
      border: none;
      border-radius: 5px;
    }

    input {
      background-color: #2c2c2c;
      color: #eee;
      border: 1px solid #555;
    }

    button {
      background-color: #ff6600;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      background-color: #e65c00;
    }

    #map {
      height: 60vh;
      width: 100%;
      margin-top: 10px;
      border: 2px solid #ff6600;
    }

    #panel {
      background-color: #2a2a2a;
      padding: 10px;
      margin-top: 10px;
      border: 1px solid #444;
      text-align: left;
    }

    .log-entry {
      font-size: 0.9em;
      margin-top: 10px;
      color: #ccc;
    }

    #qrcode {
      margin: 20px auto;
      background: #fff;
      padding: 10px;
      width: fit-content;
    }

    .marcador-azul {
      background-color: #007bff;
      color: white;
      font-weight: bold;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      line-height: 30px;
      text-align: center;
      box-shadow: 0 0 5px #000;
    }
  </style>
</head>

<body>
  <header>
    <h1>Carrera Urbana 2025</h1>
    <p>Corre Talcahuano. Sigue tu ritmo.</p>
  </header>

  <nav>
    <button onclick="mostrarPantalla('registro')">üèÅ Inscripci√≥n</button>
    <button onclick="mostrarPantalla('seguimiento')">üìç Seguimiento</button>
    <button onclick="mostrarPantalla('hitos')">üß± Hitos</button>
    <button onclick="mostrarPantalla('panel')">üìä Panel</button>
  </nav>

  <div id="pantalla-registro" class="pantalla visible">
    <h2>Inscripci√≥n de Participantes</h2>
    <input type="text" id="nombre" placeholder="Nombre del participante" />
    <input type="password" id="codigo" placeholder="C√≥digo de autorizaci√≥n" />
    <button onclick="registrar()">Registrar y generar QR</button>
    <div id="resultado"></div>
    <div id="qrcode"></div>
  </div>

  <div id="pantalla-seguimiento" class="pantalla">
    <h2>Seguimiento en Tiempo Real</h2>
    <div id="map"></div>
  </div>

  <div id="pantalla-hitos" class="pantalla">
    <h2>Agregar Hitos Manualmente</h2>
    <input type="text" id="hito-nombre" placeholder="Nombre del hito" />
    <input type="number" id="hito-lat" step="any" placeholder="Latitud" />
    <input type="number" id="hito-lon" step="any" placeholder="Longitud" />
    <input type="password" id="hito-codigo" placeholder="C√≥digo de autorizaci√≥n" />
    <button onclick="agregarHito()">Agregar Hito</button>
    <div id="lista-hitos">
      <h3>Hitos agregados:</h3>
    </div>
  </div>

  <div id="pantalla-panel" class="pantalla">
    <h2>Panel de Control</h2>
    <div id="panel">
      <h3>Avances</h3>
      <div id="log"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "running-3cd5f.firebaseapp.com",
      databaseURL: "https://running-3cd5f-default-rtdb.firebaseio.com",
      projectId: "running-3cd5f",
      storageBucket: "running-3cd5f.appspot.com",
      messagingSenderId: "TU_SENDER_ID",
      appId: "TU_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let contador = 1;
    const participantes = {};
    const hitos = [];
    const map = L.map("map").setView([-33.4372, -70.6506], 15);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap",
    }).addTo(map);

    function mostrarPantalla(id) {
      document.querySelectorAll(".pantalla").forEach(p => p.classList.remove("visible"));
      document.getElementById("pantalla-" + id).classList.add("visible");
      if (id === "seguimiento") {
        setTimeout(() => map.invalidateSize(), 300);
      }
    }

    function registrar() {
      const nombre = document.getElementById("nombre").value.trim();
      const codigo = document.getElementById("codigo").value.trim();
      if (!nombre || codigo !== "300309") {
        alert("Nombre vac√≠o o c√≥digo incorrecto.");
        return;
      }

      const id = "P" + String(contador).padStart(3, "0");
      db.ref("corredores/" + id).set({
        nombre: nombre,
        lat: 0,
        lon: 0,
        hitos: []
      });

      const url = window.location.href.split('?')[0] + `?id=${id}`;
      document.getElementById("qrcode").innerHTML = "";
      new QRCode(document.getElementById("qrcode"), {
        text: url,
        width: 128,
        height: 128,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });

      document.getElementById("resultado").innerHTML = `
        <div class="log-entry">‚úÖ <strong>${id}</strong> - ${nombre} registrado</div>
        <div class="log-entry">üì± Escanea el c√≥digo QR para vincular tu tel√©fono:</div>
      `;

      const entry = document.createElement("div");
      entry.className = "log-entry";
      entry.id = `estado-${id}`;
      entry.innerHTML = `üü† <strong>${id}</strong> - ${nombre} | Estado: <em>Sin hitos alcanzados</em>`;
      document.getElementById("log").appendChild(entry);

      document.getElementById("nombre").value = "";
      document.getElementById("codigo").value = "";
      contador++;
    }

    function iniciarGPS(id) {
      navigator.geolocation.watchPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          db.ref("corredores/" + id).update({ lat, lon });

          hitos.forEach((hito) => {
            const d = distanciaMetros(lat, lon, hito.lat, hito.lon);
            if (d < 20) {
              db.ref("corredores/" + id + "/hitos").once("value", snapshot => {
                const hitosPrevios = snapshot.val() || [];
                if (!hitosPrevios.includes(hito.nombre)) {
                  const nuevos = [...hitosPrevios, hito.nombre];
                  db.ref("corredores/" + id + "/hitos").set(nuevos);
                  const bip = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
                  bip.play();
                }
              });
            }
          });
        },
        () => console.log("No se pudo obtener la ubicaci√≥n."),
        { enableHighAccuracy: true }
      );
    }

    function distanciaMetros(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
      const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function agregarHito() {
      const nombre = document.getElementById("hito-nombre").value.trim();
      const lat = parseFloat(document.getElementById("hito-lat").value);
      const lon = parseFloat(document.getElementById("hito-lon").value);
      const codigo = document.getElementById("hito-codigo").value.trim();
      if (!nombre || isNaN(lat) || isNaN(lon) || codigo !== "300309") {
        alert("Datos inv√°lidos o c√≥digo incorrecto.");
        return;
      }

      hitos.push({ nombre, lat, lon });

      L.circle([lat, lon], {
        radius: 15,
        color: "#ff3300",
        fillColor: "#ff3300",
        fillOpacity: 0.5,
      }).bindPopup(nombre).addTo(map);

      const lista = document.getElementById("lista-hitos");
      const item = document.createElement("div");
      item.className = "log-entry";
      item.textContent = `${nombre} (${lat.toFixed(5)}, ${lon.toFixed(5)})`;
      lista.appendChild(item);

      document.getElementById("hito-nombre").value = "";
      document.getElementById("hito-lat").value = "";
      document.getElementById("hito-lon").value = "";
      document.getElementById("hito-codigo").value = "";
    }

    db.ref("corredores").on("value", snapshot => {
      const data = snapshot.val();
      for (const id in data) {
        const corredor = data[id];
        if (!participantes[id]) {
          const icono = L.divIcon({
            className: 'marcador-personalizado',
            html: `<div class="marcador-azul">${id}</div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15]
          });
          const marker = L.marker([corredor.lat, corredor.lon], { icon: icono }).addTo(map);
          participantes[id] = { marker };
        } else {
          participantes[id].marker.setLatLng([corredor.lat, corredor.lon]);
        }

        const estado = document.getElementById(`estado-${id}`);
        const total = corredor.hitos ? corredor.hitos.length : 0;
        if (!estado) {
          const entry = document.createElement("div");
          entry.className = "log-entry";
          entry.id = `estado-${id}`;
          entry.innerHTML = `üü† <strong>${id}</strong> - ${corredor.nombre} | Estado: <em>${String(total).padStart(2, "0")} hito${total !== 1 ? "s" : ""} alcanzado${total !== 1 ? "s" : ""}</em>`;
          document.getElementById("log").appendChild(entry);
        } else {
          estado.innerHTML = `üü¢ <strong>${id}</strong> - ${corredor.nombre} | Estado: <em>${String(total).padStart(2, "0")} hito${total !== 1 ? "s" : ""} alcanzado${total !== 1 ? "s" : ""}</em>`;
        }
      }
    });

    window.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");
      if (id) {
        mostrarPantalla("seguimiento");
        iniciarGPS(id);
      }
    });
  </script>
</body>

</html>