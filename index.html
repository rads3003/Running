<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  let contador = 1;
    const participantes = {};
    const hitos = [];
    const map = L.map("map").setView([-33.4372, -70.6506], 15);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Â© OpenStreetMap",
    }).addTo(map);

    function mostrarPantalla(id) {
      document.querySelectorAll(".pantalla").forEach(p => p.classList.remove("visible"));
      document.getElementById("pantalla-" + id).classList.add("visible");
      if (id === "seguimiento") {
        setTimeout(() => map.invalidateSize(), 300);
      }
    }

    function registrar() {
      const nombre = document.getElementById("nombre").value.trim();
      if (!nombre) return;

      const id = "P" + String(contador).padStart(3, "0");
      const icono = L.divIcon({
        className: 'marcador-azul',
        html: `<div class="marcador-azul">${id}</div>`,
        iconSize: [30, 30],
        iconAnchor: [15, 15]
      });

      const marker = L.marker([0, 0], { icon: icono }).addTo(map).bindPopup(`${id} - ${nombre}`);

      participantes[id] = {
        nombre,
        marker,
        hitosCumplidos: new Set()
      };

      const entry = document.createElement("div");
      entry.className = "log-entry";
      entry.id = `estado-${id}`;
      entry.innerHTML = `ðŸŸ  <strong>${id}</strong> - ${nombre} | Estado: <em>Sin hitos alcanzados</em>`;
      document.getElementById("log").appendChild(entry);

      const url = window.location.href.split('?')[0] + `?id=${id}`;
      document.getElementById("qrcode").innerHTML = "";
      new QRCode(document.getElementById("qrcode"), {
        text: url,
        width: 128,
        height: 128,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });

      document.getElementById("resultado").innerHTML = `
        <div class="log-entry">âœ… <strong>${id}</strong> - ${nombre} registrado</div>
        <div class="log-entry">ðŸ“± Escanea el cÃ³digo QR para vincular tu telÃ©fono:</div>
      `;

      document.getElementById("nombre").value = "";
      contador++;
    }

    function iniciarGPS(id) {
      navigator.geolocation.watchPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const p = participantes[id];
          if (p && p.marker) {
            p.marker.setLatLng([lat, lon]);
            map.setView([lat, lon]);
          }

          hitos.forEach((hito) => {
            const d = distanciaMetros(lat, lon, hito.lat, hito.lon);
            if (d < 20 && !p.hitosCumplidos.has(hito.nombre)) {
              p.hitosCumplidos.add(hito.nombre);
              const estado = document.getElementById(`estado-${id}`);
              if (estado) {
                estado.innerHTML = `ðŸŸ¢ <strong>${id}</strong> - ${p.nombre} | Estado: <em>${String(p.hitosCumplidos.size).padStart(2, "0")} hito${p.hitosCumplidos.size > 1 ? "s" : ""} cumplido${p.hitosCumplidos.size > 1 ? "s" : ""}</em>`;
              }
              const bip = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
              bip.play();
            }
          });
        },
        () => console.log("No se pudo obtener la ubicaciÃ³n."),
        { enableHighAccuracy: true }
      );
    }

    function distanciaMetros(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const Ï†1 = lat1 * Math.PI / 180;
      const Ï†2 = lat2 * Math.PI / 180;
      const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
      const Î”Î» = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                Math.cos(Ï†1) * Math.cos(Ï†2) *
                Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function agregarHito() {
      const nombre = document.getElementById("hito-nombre").value.trim();
      const lat = parseFloat(document.getElementById("hito-lat").value);
      const lon = parseFloat(document.getElementById("hito-lon").value);
      if (!nombre || isNaN(lat) || isNaN(lon)) return;

      hitos.push({ nombre, lat, lon });

      L.circle([lat, lon], {
        radius: 15,
        color: "#ff3300",
        fillColor: "#ff3300",
        fillOpacity: 0.5,
      }).bindPopup(nombre).addTo(map);

      document.getElementById("hito-nombre").value = "";
      document.getElementById("hito-lat").value = "";
      document.getElementById("hito-lon").value = "";
    }

    window.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");
      if (id) {
        mostrarPantalla("seguimiento");

        const marker = L.circleMarker([0, 0], {
          radius: 10,
          color: "#ff0000",
          fillColor: "#ff0000",
          fillOpacity: 0.9,
        }).addTo(map).bindPopup(`${id} (activo)`);

        participantes[id] = {
          nombre: id,
          marker,
          hitosCumplidos: new Set()
        };

        const entry = document.createElement("div");
        entry.className = "log-entry";
        entry.id = `estado-${id}`;
        entry.innerHTML = `ðŸŸ  <strong>${id}</strong> - ${id} | Estado: <em>Sin hitos alcanzados</em>`;
        document.getElementById("log").appendChild(entry);

        iniciarGPS(id);
      } else {
        mostrarPantalla("registro");
      }
    });
</script>
</body>

</html>